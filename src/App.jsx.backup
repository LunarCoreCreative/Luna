import { useState, useEffect, useRef } from "react";
import { Send, Loader2, Brain, ChevronDown, ChevronUp, Sparkles, Folder, File, X, Code, Terminal as TerminalIcon, FolderTree, Image as ImageIcon, Paperclip, Globe, MessageSquare, Trash2, Edit3, FileText, List, Plus, GripVertical, ArrowUp, ArrowDown, FolderPlus, Check } from "lucide-react";
import ReactMarkdown from "react-markdown";
import remarkGfm from "remark-gfm";
import { Prism as SyntaxHighlighter } from "react-syntax-highlighter";
import { oneDark } from "react-syntax-highlighter/dist/esm/styles/prism";
import Editor from "@monaco-editor/react";
import MDEditor from '@uiw/react-md-editor';

const MEMORY_SERVER = "http://127.0.0.1:8001";

// Componente de pensamento colaps√°vel estilo o1
function ThinkingPanel({ thinking, isActive, MarkdownRenderer }) {
    const [isExpanded, setIsExpanded] = useState(true);

    if (!thinking && !isActive) return null;

    return (
        <div className="mb-2 border-l-2 border-violet-500/30 ml-2 pl-4 py-1">
            <button
                onClick={() => setIsExpanded(!isExpanded)}
                className="flex items-center gap-2 text-[11px] text-violet-400/70 hover:text-violet-300 transition-colors uppercase tracking-wider font-bold"
            >
                <Sparkles size={10} className={isActive ? "animate-pulse" : ""} />
                <span>{isActive ? "Pensando..." : "Racioc√≠nio"}</span>
                {isExpanded ? <ChevronUp size={12} /> : <ChevronDown size={12} />}
            </button>

            {isExpanded && (
                <div className="mt-2 text-[12px] text-white/50 leading-relaxed italic pr-4">
                    {thinking ? (
                        <MarkdownRenderer content={thinking} />
                    ) : (
                        <span className="animate-pulse">Analisando contexto...</span>
                    )}
                </div>
            )}
        </div>
    );
}

// Componente de Explorer de Arquivos (Recursivo)
function FileExplorer({ tree, projectRoot, activeFile, onFileClick, onToggleFolder }) {
    if (!tree || tree.length === 0) return (
        <div className="p-4 text-white/20 text-xs italic">Nenhum projeto aberto</div>
    );

    return (
        <div className="space-y-0.5 py-1">
            {tree.map((item, idx) => (
                <FileExplorerItem
                    key={item.path || idx}
                    item={item}
                    activeFile={activeFile}
                    onFileClick={onFileClick}
                    onToggleFolder={onToggleFolder}
                />
            ))}
        </div>
    );
}

// Componente de Sidebar de Chats com Threads
function ChatSidebar({ chats, currentChatId, currentThreadId, onLoadChat, onLoadThread, onNewChat, onRefresh }) {
    const [expandedChats, setExpandedChats] = useState({});

    const handleDelete = async (e, id) => {
        e.stopPropagation();
        if (confirm("Apagar esta conversa e todas as threads?")) {
            await fetch(`${MEMORY_SERVER}/chats/${id}`, { method: "DELETE" });
            onRefresh();
        }
    };

    const handleDeleteThread = async (e, chatId, threadId) => {
        e.stopPropagation();
        if (confirm("Apagar esta thread?")) {
            await fetch(`${MEMORY_SERVER}/chats/${chatId}/threads/${threadId}`, { method: "DELETE" });
            onRefresh();
        }
    };

    const toggleExpand = (e, chatId) => {
        e.stopPropagation();
        setExpandedChats(prev => ({ ...prev, [chatId]: !prev[chatId] }));
    };

    const handleCreateThread = async (e, chatId) => {
        e.stopPropagation();
        const title = prompt("Nome da Thread:");
        if (title) {
            const res = await fetch(`${MEMORY_SERVER}/chats/${chatId}/threads`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ title })
            });
            const data = await res.json();
            if (data.success) {
                onRefresh();
                onLoadThread(chatId, data.thread.id);
            }
        }
    };

    return (
        <div className="flex flex-col h-full bg-dark-900">
            <div className="p-3 pb-0">
                <button
                    onClick={onNewChat}
                    className="w-full flex items-center justify-center gap-2 bg-violet-600 hover:bg-violet-500 active:bg-violet-700 text-white py-2 rounded-lg text-[11px] font-bold uppercase tracking-wider transition-all shadow-lg shadow-violet-900/20"
                >
                    <Sparkles size={14} /> Novo Chat
                </button>
            </div>

            <div className="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-1">
                {chats.length === 0 && (
                    <div className="text-center text-white/20 text-xs italic mt-10">
                        Nenhuma conversa salva.
                    </div>
                )}
                {chats.map(chat => (
                    <div key={chat.id} className="space-y-0.5">
                        {/* Chat Principal */}
                        <div
                            onClick={() => onLoadChat(chat.id)}
                            className={`group p-2.5 rounded-lg cursor-pointer border transition-all relative ${currentChatId === chat.id && !currentThreadId ? "bg-violet-500/20 border-violet-500/50" : "bg-transparent border-transparent hover:bg-white/5"}`}
                        >
                            <div className="flex items-center gap-2">
                                {chat.threads?.length > 0 && (
                                    <button onClick={(e) => toggleExpand(e, chat.id)} className="text-white/30 hover:text-white/60">
                                        {expandedChats[chat.id] ? <ChevronDown size={12} /> : <ChevronUp size={12} className="-rotate-90" />}
                                    </button>
                                )}
                                <span className={`text-[12px] font-medium truncate flex-1 ${currentChatId === chat.id ? "text-violet-200" : "text-white/80"}`}>{chat.title}</span>
                                <div className="flex gap-1 opacity-0 group-hover:opacity-100">
                                    <button onClick={(e) => handleCreateThread(e, chat.id)} className="text-white/20 hover:text-emerald-400 p-1" title="Nova Thread">
                                        <MessageSquare size={10} />
                                    </button>
                                    <button onClick={(e) => handleDelete(e, chat.id)} className="text-white/20 hover:text-red-400 p-1" title="Apagar">
                                        <Trash2 size={10} />
                                    </button>
                                </div>
                            </div>
                            {chat.thread_count > 0 && (
                                <div className="text-[9px] text-white/20 mt-1 ml-5">
                                    üßµ {chat.thread_count} thread{chat.thread_count > 1 ? 's' : ''}
                                </div>
                            )}
                        </div>

                        {/* Threads */}
                        {expandedChats[chat.id] && chat.threads?.map(thread => (
                            <div
                                key={thread.id}
                                onClick={() => onLoadThread(chat.id, thread.id)}
                                className={`group ml-4 p-2 pl-3 rounded-lg cursor-pointer border-l-2 transition-all ${currentThreadId === thread.id ? "bg-emerald-500/10 border-emerald-400" : "border-white/10 hover:border-white/30 hover:bg-white/5"}`}
                            >
                                <div className="flex items-center justify-between">
                                    <span className={`text-[11px] truncate ${currentThreadId === thread.id ? "text-emerald-300" : "text-white/60"}`}>üßµ {thread.title}</span>
                                    <button onClick={(e) => handleDeleteThread(e, chat.id, thread.id)} className="opacity-0 group-hover:opacity-100 text-white/20 hover:text-red-400 p-0.5">
                                        <Trash2 size={10} />
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                ))}
            </div>
        </div>
    );
}

function FileExplorerItem({ item, activeFile, onFileClick, onToggleFolder }) {
    const [isExpanded, setIsExpanded] = useState(false);

    const handleToggle = () => {
        setIsExpanded(!isExpanded);
        if (item.type === "dir" && !isExpanded) {
            onToggleFolder(item);
        }
    };

    return (
        <div className="select-none">
            {item.type === "dir" ? (
                <div>
                    <div
                        onClick={handleToggle}
                        className="flex items-center gap-1.5 px-3 py-1 hover:bg-white/5 cursor-pointer text-[12px] text-white/60 transition-colors group"
                    >
                        <div className="w-4 h-4 flex items-center justify-center">
                            {isExpanded ? <ChevronDown size={12} /> : <ChevronUp size={12} className="-rotate-90" />}
                        </div>
                        <Folder size={14} className="text-violet-400 group-hover:text-violet-300" />
                        <span className="truncate">{item.name}</span>
                    </div>
                    {isExpanded && item.children && (
                        <div className="ml-3 border-l border-white/10 pl-1 animate-in slide-in-from-top-1 duration-200">
                            {item.children.map((child, cidx) => (
                                <FileExplorerItem
                                    key={child.path || cidx}
                                    item={child}
                                    activeFile={activeFile}
                                    onFileClick={onFileClick}
                                    onToggleFolder={onToggleFolder}
                                />
                            ))}
                        </div>
                    )}
                    {isExpanded && !item.children && (
                        <div className="ml-8 py-1 text-[10px] text-white/20 italic animate-pulse">Carregando...</div>
                    )}
                </div>
            ) : (
                <div
                    onClick={() => onFileClick(item)}
                    className={`flex items-center gap-2 px-3 py-1 pl-7 hover:bg-white/5 cursor-pointer text-[12px] transition-colors ${activeFile?.path === item.path ? "bg-violet-500/20 text-violet-300 border-r-2 border-violet-500" : "text-white/60"}`}
                >
                    <File size={14} className="text-blue-400/70" />
                    <span className="truncate">{item.name}</span>
                </div>
            )}
        </div>
    );
}

// =============================================================================
// MODO WRITER - Canvas de Documentos (com UX melhorado)
// =============================================================================

// Componente de Item de Se√ß√£o com todas as funcionalidades
function SectionItem({
    section,
    isActive,
    isUpdated,
    isEditing,
    editValue,
    onEditValueChange,
    onEditStart,
    onEditSave,
    onEditCancel,
    onSelect,
    onDelete,
    onMoveUp,
    onMoveDown,
    onDragStart,
    onDragOver,
    onDragLeave,
    onDrop,
    isDragged,
    isDragOver,
    canMoveUp,
    canMoveDown,
    folders,
    currentFolderId,
    onMoveToFolder,
    indent = false
}) {
    const handleKeyDown = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            onEditSave();
        } else if (e.key === 'Escape') {
            e.preventDefault();
            onEditCancel();
        }
    };

    return (
        <div
            draggable={!isEditing}
            onDragStart={(e) => onDragStart(e, section.id)}
            onDragOver={(e) => onDragOver(e, section.id)}
            onDragLeave={onDragLeave}
            onDrop={(e) => onDrop(e, section.id)}
            onClick={!isEditing ? onSelect : undefined}
            className={`section-item group relative ${indent ? 'ml-4' : ''} transition-all ${isDragged ? 'opacity-50' : ''
                } ${isDragOver ? 'border-t-2 border-emerald-500' : ''}`}
        >
            <div className={`p-2 rounded-lg cursor-pointer flex items-center gap-2 transition-all text-[11px] border ${isActive
                ? "bg-emerald-500/15 text-emerald-300 border-emerald-500/30 shadow-lg shadow-emerald-500/10"
                : "hover:bg-white/5 text-white/50 border-transparent hover:border-white/10"
                } ${isUpdated ? 'section-updated-glow' : ''}`}>
                {/* Grip para drag */}
                <div className="cursor-move text-white/20 hover:text-white/40 transition-colors flex-shrink-0">
                    <GripVertical size={12} />
                </div>

                {/* √çcone ou input de edi√ß√£o */}
                {isEditing ? (
                    <input
                        type="text"
                        value={editValue}
                        onChange={(e) => onEditValueChange(e.target.value)}
                        onKeyDown={handleKeyDown}
                        onBlur={onEditSave}
                        autoFocus
                        className="flex-1 bg-emerald-500/20 border border-emerald-500/50 rounded px-2 py-0.5 text-[11px] text-emerald-100 outline-none focus:border-emerald-400"
                        onClick={(e) => e.stopPropagation()}
                    />
                ) : (
                    <>
                        <FileText size={12} className={`flex-shrink-0 ${isActive ? "text-emerald-400" : "text-white/30"}`} />
                        <span
                            className="truncate flex-1 cursor-text"
                            onDoubleClick={(e) => { e.stopPropagation(); onEditStart(); }}
                            title="Duplo clique para editar"
                        >
                            {section.title}
                        </span>
                    </>
                )}

                {/* Bot√µes de a√ß√£o (aparecem no hover) */}
                {!isEditing && (
                    <div className="flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0">
                        {/* Bot√µes de mover */}
                        <div className="flex flex-col">
                            <button
                                onClick={(e) => { e.stopPropagation(); canMoveUp && onMoveUp(); }}
                                disabled={!canMoveUp}
                                className={`p-0.5 ${canMoveUp ? 'text-white/30 hover:text-emerald-400' : 'text-white/10 cursor-not-allowed'}`}
                                title="Mover para cima"
                            >
                                <ArrowUp size={10} />
                            </button>
                            <button
                                onClick={(e) => { e.stopPropagation(); canMoveDown && onMoveDown(); }}
                                disabled={!canMoveDown}
                                className={`p-0.5 ${canMoveDown ? 'text-white/30 hover:text-emerald-400' : 'text-white/10 cursor-not-allowed'}`}
                                title="Mover para baixo"
                            >
                                <ArrowDown size={10} />
                            </button>
                        </div>

                        {/* Menu de pasta (se houver pastas) */}
                        {folders.length > 0 && (
                            <div className="relative group/pasta">
                                <button
                                    onClick={(e) => { e.stopPropagation(); }}
                                    className="p-0.5 text-white/30 hover:text-blue-400"
                                    title="Mover para pasta"
                                >
                                    <Folder size={10} />
                                </button>
                                <div className="absolute left-0 top-full mt-1 bg-dark-800 border border-white/10 rounded-lg shadow-xl py-1 z-50 opacity-0 invisible group-hover/pasta:opacity-100 group-hover/pasta:visible transition-all min-w-[120px]">
                                    <button
                                        onClick={(e) => { e.stopPropagation(); onMoveToFolder(section.id, null); }}
                                        className="w-full px-3 py-1.5 text-left text-[10px] text-white/60 hover:bg-white/5 hover:text-white"
                                    >
                                        Sem pasta
                                    </button>
                                    {folders.map(f => (
                                        <button
                                            key={f.id}
                                            onClick={(e) => { e.stopPropagation(); onMoveToFolder(section.id, f.id); }}
                                            className={`w-full px-3 py-1.5 text-left text-[10px] hover:bg-white/5 transition-colors ${currentFolderId === f.id ? 'text-blue-400' : 'text-white/60 hover:text-white'
                                                }`}
                                        >
                                            {f.name}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Bot√£o deletar */}
                        <button
                            onClick={(e) => { e.stopPropagation(); onDelete(); }}
                            className="p-0.5 text-white/20 hover:text-red-400 hover:bg-red-500/10 rounded transition-all"
                            title="Deletar se√ß√£o"
                        >
                            <Trash2 size={10} />
                        </button>
                    </div>
                )}

                {/* Bot√µes de salvar/cancelar durante edi√ß√£o */}
                {isEditing && (
                    <div className="flex gap-1 flex-shrink-0">
                        <button
                            onClick={(e) => { e.stopPropagation(); onEditSave(); }}
                            className="p-0.5 text-emerald-400 hover:bg-emerald-500/20 rounded"
                            title="Salvar"
                        >
                            <Check size={10} />
                        </button>
                        <button
                            onClick={(e) => { e.stopPropagation(); onEditCancel(); }}
                            className="p-0.5 text-red-400 hover:bg-red-500/20 rounded"
                            title="Cancelar"
                        >
                            <X size={10} />
                        </button>
                    </div>
                )}
            </div>
        </div>
    );
}

// Toast Component para notifica√ß√µes
function WriterToast({ message, visible, type = "success" }) {
    if (!visible) return null;

    const icons = {
        success: <Sparkles size={14} className="text-emerald-400" />,
        writing: <Loader2 size={14} className="text-violet-400 animate-spin" />,
        info: <Edit3 size={14} className="text-blue-400" />
    };

    return (
        <div className={`fixed bottom-24 left-1/2 -translate-x-1/2 z-50 ${visible ? 'toast-enter' : 'toast-exit'}`}>
            <div className={`flex items-center gap-2 px-4 py-2.5 rounded-xl border shadow-2xl backdrop-blur-xl ${type === 'success' ? 'bg-emerald-500/10 border-emerald-500/30 text-emerald-300' :
                type === 'writing' ? 'bg-violet-500/10 border-violet-500/30 text-violet-300' :
                    'bg-blue-500/10 border-blue-500/30 text-blue-300'
                }`}>
                {icons[type]}
                <span className="text-[12px] font-medium">{message}</span>
            </div>
        </div>
    );
}

// Quick Actions Bar - A√ß√µes r√°pidas da Luna (estilo ChatGPT Canvas)
function QuickActionsBar({ onAction, disabled, currentContent }) {
    const [showToneMenu, setShowToneMenu] = useState(false);

    const quickActions = [
        {
            id: 'expand', icon: '‚ú®', label: 'Expandir',
            prompt: 'Expanda o texto atual com mais detalhes, descri√ß√µes v√≠vidas e profundidade. Mantenha o tom e estilo original.'
        },
        {
            id: 'summarize', icon: 'üìù', label: 'Resumir',
            prompt: 'Resuma o texto atual de forma mais concisa, mantendo os pontos principais e a ess√™ncia da mensagem.'
        },
        {
            id: 'polish', icon: 'üéØ', label: 'Polish',
            prompt: 'Revise o texto: corrija gram√°tica, melhore clareza, fluidez e consist√™ncia. Mantenha o conte√∫do original.'
        },
        {
            id: 'emojis', icon: 'üòÄ', label: 'Emojis',
            prompt: 'Adicione emojis relevantes e expressivos ao texto para dar √™nfase e personalidade, sem exagerar.'
        },
    ];

    const toneOptions = [
        { id: 'casual', label: 'üí¨ Casual', prompt: 'Reescreva o texto em um tom mais casual e descontra√≠do, como uma conversa entre amigos.' },
        { id: 'professional', label: 'üíº Profissional', prompt: 'Reescreva o texto em um tom mais profissional e formal, adequado para ambientes corporativos.' },
        { id: 'technical', label: 'üî¨ T√©cnico', prompt: 'Reescreva o texto em um tom mais t√©cnico e preciso, com terminologia especializada quando apropriado.' },
        { id: 'creative', label: 'üé® Criativo', prompt: 'Reescreva o texto de forma mais criativa e expressiva, com met√°foras e linguagem rica.' },
        { id: 'simple', label: 'üìñ Simples', prompt: 'Simplifique o texto para ser facilmente compreendido por qualquer pessoa, evitando jarg√µes.' },
    ];

    return (
        <div className="flex items-center gap-1 px-3 py-2 bg-dark-800/50 border-b border-white/5 backdrop-blur-sm">
            {quickActions.map(action => (
                <button
                    key={action.id}
                    onClick={() => onAction(action.prompt)}
                    disabled={disabled}
                    className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-[11px] font-medium transition-all
                        ${disabled
                            ? 'opacity-40 cursor-not-allowed bg-white/5 text-white/30'
                            : 'bg-white/5 hover:bg-violet-500/20 text-white/60 hover:text-violet-300 border border-transparent hover:border-violet-500/30'
                        }`}
                    title={action.label}
                >
                    <span>{action.icon}</span>
                    <span>{action.label}</span>
                </button>
            ))}

            {/* Dropdown de Tom */}
            <div className="relative">
                <button
                    onClick={() => setShowToneMenu(!showToneMenu)}
                    disabled={disabled}
                    className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-[11px] font-medium transition-all
                        ${disabled
                            ? 'opacity-40 cursor-not-allowed bg-white/5 text-white/30'
                            : 'bg-white/5 hover:bg-blue-500/20 text-white/60 hover:text-blue-300 border border-transparent hover:border-blue-500/30'
                        }`}
                    title="Alterar Tom"
                >
                    <span>üìö</span>
                    <span>Tom</span>
                    <ChevronDown size={10} className={`transition-transform ${showToneMenu ? 'rotate-180' : ''}`} />
                </button>

                {showToneMenu && !disabled && (
                    <div className="absolute top-full left-0 mt-1 bg-dark-800 border border-white/10 rounded-xl shadow-2xl py-1 z-50 min-w-[160px] animate-in fade-in slide-in-from-top-2 duration-200">
                        {toneOptions.map(tone => (
                            <button
                                key={tone.id}
                                onClick={() => {
                                    onAction(tone.prompt);
                                    setShowToneMenu(false);
                                }}
                                className="w-full px-3 py-2 text-left text-[11px] text-white/60 hover:bg-white/5 hover:text-white transition-colors"
                            >
                                {tone.label}
                            </button>
                        ))}
                    </div>
                )}
            </div>

            {/* Indicador de loading */}
            {disabled && (
                <div className="ml-auto flex items-center gap-1.5 text-[10px] text-violet-400">
                    <Loader2 size={10} className="animate-spin" />
                    <span>Processando...</span>
                </div>
            )}
        </div>
    );
}

// Selection Popup - Aparece quando texto √© selecionado (estilo ChatGPT Canvas)
function SelectionPopup({ selectedText, position, onAction, onClose, disabled }) {
    if (!selectedText || !position) return null;

    const actions = [
        {
            id: 'improve', icon: '‚ú®', label: 'Melhorar',
            prompt: (text) => `Melhore o seguinte trecho, tornando-o mais claro, envolvente e bem escrito:\n\n"${text}"`
        },
        {
            id: 'explain', icon: 'üìñ', label: 'Explicar',
            prompt: (text) => `Explique o que significa o seguinte trecho do texto e seu contexto:\n\n"${text}"`
        },
        {
            id: 'rewrite', icon: 'üîÑ', label: 'Reescrever',
            prompt: (text) => `Reescreva o seguinte trecho de uma forma diferente, mantendo o significado:\n\n"${text}"`
        },
    ];

    return (
        <div
            className="fixed z-50 animate-in fade-in slide-in-from-bottom-2 duration-200"
            style={{
                left: Math.min(position.x, window.innerWidth - 250),
                top: position.y + 10
            }}
        >
            <div className="bg-dark-800 border border-white/10 rounded-xl shadow-2xl p-1 flex items-center gap-0.5 backdrop-blur-xl">
                {actions.map(action => (
                    <button
                        key={action.id}
                        onClick={() => {
                            onAction(action.prompt(selectedText));
                            onClose();
                        }}
                        disabled={disabled}
                        className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-[11px] font-medium transition-all
                            ${disabled
                                ? 'opacity-40 cursor-not-allowed text-white/30'
                                : 'hover:bg-violet-500/20 text-white/60 hover:text-violet-300'
                            }`}
                        title={action.label}
                    >
                        <span>{action.icon}</span>
                        <span>{action.label}</span>
                    </button>
                ))}

                {/* Bot√£o Fechar */}
                <button
                    onClick={onClose}
                    className="p-1.5 text-white/30 hover:text-white/60 hover:bg-white/5 rounded-lg transition-all ml-1"
                    title="Fechar"
                >
                    <X size={12} />
                </button>
            </div>

            {/* Tri√¢ngulo apontando para a sele√ß√£o */}
            <div className="absolute -top-1.5 left-4 w-0 h-0 border-l-4 border-r-4 border-b-4 border-l-transparent border-r-transparent border-b-dark-800" />
        </div>
    );
}

function WriterView({ onBack, onDocumentChange, isLunaLoading, onQuickAction }) {
    const [sections, setSections] = useState([
        { id: '1', title: 'Introdu√ß√£o', content: '# Bem-vindo ao Modo Writer\n\nComece a escrever seu documento aqui.\n\n## Dicas\n- Escreva em **Markdown**\n- Adicione se√ß√µes √† esquerda\n- Fale com a Luna no chat √† direita', folderId: null }
    ]);
    const [folders, setFolders] = useState([]); // [{ id, name, expanded: true }]
    const [activeSection, setActiveSection] = useState('1');
    const [currentDocId, setCurrentDocId] = useState(null);
    const [docTitle, setDocTitle] = useState("Novo Documento");
    const [sidebarVisible, setSidebarVisible] = useState(true);
    const [lockedSectionId, setLockedSectionId] = useState(null);
    const [lockedSectionTitle, setLockedSectionTitle] = useState(null);

    // Estados para sele√ß√£o de texto (Selection Popup)
    const [selectedText, setSelectedText] = useState(null);
    const [selectionPosition, setSelectionPosition] = useState(null);
    const editorContainerRef = useRef(null);

    // Estados para controle de vers√£o (Undo/Redo)
    const [contentHistory, setContentHistory] = useState([]);
    const [historyIndex, setHistoryIndex] = useState(-1);
    const lastSavedContentRef = useRef('');
    const MAX_HISTORY = 20;

    // Auto-save Documento
    useEffect(() => {
        const timer = setTimeout(async () => {
            if (sections.length > 0) {
                try {
                    const res = await fetch(`${MEMORY_SERVER}/canvas`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            id: currentDocId,
                            title: docTitle,
                            sections: sections,
                            folders: folders
                        })
                    });
                    const data = await res.json();
                    if (data.success && !currentDocId) {
                        setCurrentDocId(data.document.id);
                    }
                } catch (e) { console.error("Erro auto-save canvas:", e); }
            }
        }, 3000);
        return () => clearTimeout(timer);
    }, [sections, folders, docTitle, currentDocId]);

    // Estados de edi√ß√£o e drag
    const [editingSectionId, setEditingSectionId] = useState(null);
    const [editTitleValue, setEditTitleValue] = useState('');
    const [draggedSectionId, setDraggedSectionId] = useState(null);
    const [dragOverId, setDragOverId] = useState(null);

    // Estados de UX melhorado
    const [lunaWriting, setLunaWriting] = useState(false);
    const [updatedSectionId, setUpdatedSectionId] = useState(null);
    const [toast, setToast] = useState({ visible: false, message: '', type: 'success' });

    const currentSection = sections.find(s => s.id === activeSection);
    const content = currentSection?.content || '';

    // Fun√ß√£o para mostrar toast
    const showToast = (message, type = 'success', duration = 3000) => {
        setToast({ visible: true, message, type });
        setTimeout(() => setToast(prev => ({ ...prev, visible: false })), duration);
    };

    // Listener para detectar sele√ß√£o de texto no editor
    useEffect(() => {
        const handleSelectionChange = () => {
            const selection = window.getSelection();
            const text = selection?.toString().trim();

            if (text && text.length > 3 && editorContainerRef.current) {
                // Verifica se a sele√ß√£o est√° dentro do editor
                const range = selection.getRangeAt(0);
                const editorEl = editorContainerRef.current;
                if (editorEl.contains(range.commonAncestorContainer)) {
                    const rect = range.getBoundingClientRect();
                    setSelectedText(text);
                    setSelectionPosition({ x: rect.left, y: rect.bottom });
                }
            } else {
                // Pequeno delay para permitir clique nos bot√µes do popup
                setTimeout(() => {
                    const sel = window.getSelection()?.toString().trim();
                    if (!sel || sel.length <= 3) {
                        setSelectedText(null);
                        setSelectionPosition(null);
                    }
                }, 150);
            }
        };

        document.addEventListener('selectionchange', handleSelectionChange);
        return () => document.removeEventListener('selectionchange', handleSelectionChange);
    }, []);

    // Notifica App sobre contexto do documento para Luna
    useEffect(() => {
        const activeS = sections.find(s => s.id === activeSection);
        onDocumentChange?.({
            activeSectionId: activeSection,
            sectionTitle: activeS?.title || '',
            lockedSectionId,
            lockedSectionTitle,
            sections: sections.map(s => ({ id: s.id, title: s.title, content: s.content }))
        });
    }, [sections, activeSection]);

    // Detecta quando Luna est√° processando
    useEffect(() => {
        if (isLunaLoading) {
            setLunaWriting(true);
        }
    }, [isLunaLoading]);

    // Listener para atualiza√ß√µes de documento da Luna
    useEffect(() => {
        const handleLunaUpdate = (e) => {
            // Suporta tanto snake_case (backend) quanto camelCase
            const detail = e.detail || {};
            const action = detail.action;
            const newContent = detail.content || detail.newContent;
            const sectionTitle = detail.section_title || detail.sectionTitle; // Backend usa section_title
            const mode = detail.mode || 'replace';
            const old_title = detail.old_title;
            const new_title = detail.new_title;

            console.log('[Writer] Atualiza√ß√£o recebida:', { action, sectionTitle, mode, hasContent: !!newContent });

            // Helper para busca robusta de se√ß√£o
            const findSectionByTitle = (title) => {
                if (!title) return null;
                const normalize = (s) => (s || "")
                    .toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .replace(/\s+/g, ' ')
                    .trim();
                const target = normalize(title);
                let found = sections.find(s => normalize(s.title) === target);
                if (found) return found;
                // Toler√¢ncia: prefixo/sufixo e contains
                found = sections.find(s => {
                    const st = normalize(s.title);
                    return st.includes(target) || target.includes(st);
                });
                return found || null;
            };

            // 1. Caso: Renomear Se√ß√£o
            if (action === 'section_rename') {
                const existing = findSectionByTitle(old_title);
                if (existing) {
                    setSections(prev => prev.map(s => s.id === existing.id ? { ...s, title: new_title } : s));
                    showToast(`Se√ß√£o renomeada para "${new_title}"`, 'success');
                    setUpdatedSectionId(existing.id);
                }
            }
            // 2. Caso: Deletar Se√ß√£o
            else if (action === 'section_delete') {
                const existing = findSectionByTitle(sectionTitle);
                if (existing) {
                    if (sections.length > 1) {
                        setSections(prev => prev.filter(s => s.id !== existing.id));
                        if (activeSection === existing.id) setActiveSection(sections.find(s => s.id !== existing.id).id);
                        showToast(`Se√ß√£o "${sectionTitle}" removida`, 'success');
                    }
                }
            }
            // 3. Caso: Escrever Documento (Padr√£o) ou document_update
            else if (action === 'document_update' || !action) {
                if (!newContent) {
                    console.warn('[Writer] Tentativa de atualiza√ß√£o sem conte√∫do');
                    return;
                }

                // Mostra toast de sucesso
                const targetSection = sectionTitle || currentSection?.title || 'documento';
                showToast(`Luna atualizou "${targetSection}"`, 'success');
                setLunaWriting(false);

                if (sectionTitle) {
                    // Se tem t√≠tulo de se√ß√£o, cria nova ou atualiza existente (robusto)
                    const existing = findSectionByTitle(sectionTitle);
                    if (existing) {
                        setSections(prev => prev.map(s =>
                            s.id === existing.id
                                ? { ...s, content: mode === 'append' ? s.content + '\n' + newContent : newContent }
                                : s
                        ));
                        setActiveSection(existing.id);
                        setUpdatedSectionId(existing.id);
                    } else {
                        // Cria nova se√ß√£o
                        const newId = Date.now().toString();
                        setSections(prev => [...prev, { id: newId, title: sectionTitle, content: newContent, folderId: null }]);
                        setActiveSection(newId);
                        setUpdatedSectionId(newId);
                    }
                } else {
                    // Atualiza se√ß√£o atual
                    setSections(prev => prev.map(s =>
                        s.id === activeSection
                            ? { ...s, content: mode === 'append' ? s.content + '\n' + newContent : newContent }
                            : s
                    ));
                    setUpdatedSectionId(activeSection);
                }
            }

            // Remove glow ap√≥s anima√ß√£o
            setTimeout(() => setUpdatedSectionId(null), 2000);
        };

        window.addEventListener('luna-document-update', handleLunaUpdate);

        const handleLoadDocEvent = (e) => {
            const doc = e.detail;
            if (doc) {
                setSections(doc.sections || []);
                setFolders(doc.folders || []);
                setCurrentDocId(doc.id);
                setDocTitle(doc.title || "Documento");
                if (doc.sections && doc.sections.length > 0) {
                    setActiveSection(doc.sections[0].id);
                }
            }
        };
        window.addEventListener('load-canvas-doc', handleLoadDocEvent);

        return () => {
            window.removeEventListener('luna-document-update', handleLunaUpdate);
            window.removeEventListener('load-canvas-doc', handleLoadDocEvent);
        };
    }, [activeSection, sections, currentSection?.title]);

    const handleContentChange = (value) => {
        const newValue = value || '';

        // Salva snapshot para Undo (debounce - s√≥ salva se conte√∫do mudou significativamente)
        const oldContent = currentSection?.content || '';
        if (newValue !== oldContent && Math.abs(newValue.length - lastSavedContentRef.current.length) > 10) {
            // Adiciona ao hist√≥rico
            setContentHistory(prev => {
                const newHistory = [...prev.slice(0, historyIndex + 1), oldContent];
                // Limita a MAX_HISTORY
                if (newHistory.length > MAX_HISTORY) {
                    return newHistory.slice(-MAX_HISTORY);
                }
                return newHistory;
            });
            setHistoryIndex(prev => Math.min(prev + 1, MAX_HISTORY - 1));
            lastSavedContentRef.current = newValue;
        }

        setSections(prev => prev.map(s =>
            s.id === activeSection ? { ...s, content: newValue } : s
        ));
    };

    // Fun√ß√µes de Undo/Redo
    const handleUndo = () => {
        if (historyIndex >= 0 && contentHistory[historyIndex]) {
            const previousContent = contentHistory[historyIndex];
            setSections(prev => prev.map(s =>
                s.id === activeSection ? { ...s, content: previousContent } : s
            ));
            setHistoryIndex(prev => prev - 1);
            showToast('Undo realizado', 'info');
        }
    };

    const handleRedo = () => {
        if (historyIndex < contentHistory.length - 1) {
            const nextContent = contentHistory[historyIndex + 1] || currentSection?.content;
            // Para Redo, precisamos ir para frente no hist√≥rico
            // Nota: implementa√ß√£o simples - s√≥ funciona ap√≥s undo
            setHistoryIndex(prev => prev + 1);
            showToast('Redo realizado', 'info');
        }
    };

    const canUndo = historyIndex >= 0 && contentHistory.length > 0;
    const canRedo = historyIndex < contentHistory.length - 1;

    // Fun√ß√µes de edi√ß√£o de t√≠tulo
    const startEditingTitle = (id, currentTitle) => {
        setEditingSectionId(id);
        setEditTitleValue(currentTitle);
    };

    const saveTitleEdit = (id) => {
        if (editTitleValue.trim()) {
            setSections(prev => prev.map(s => s.id === id ? { ...s, title: editTitleValue.trim() } : s));
            showToast('T√≠tulo atualizado', 'success');
        }
        setEditingSectionId(null);
        setEditTitleValue('');
    };

    const cancelTitleEdit = () => {
        setEditingSectionId(null);
        setEditTitleValue('');
    };

    // Fun√ß√µes de reordena√ß√£o (considera pastas)
    const moveSection = (id, direction) => {
        const section = sections.find(s => s.id === id);
        if (!section) return;

        // Filtra se√ß√µes do mesmo grupo (mesma pasta ou sem pasta)
        const sameGroup = sections.filter(s => s.folderId === section.folderId);
        const currentIndex = sameGroup.findIndex(s => s.id === id);
        if (currentIndex === -1) return;

        const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
        if (newIndex < 0 || newIndex >= sameGroup.length) return;

        const targetId = sameGroup[newIndex].id;
        const allIndex = sections.findIndex(s => s.id === id);
        const targetAllIndex = sections.findIndex(s => s.id === targetId);

        setSections(prev => {
            const newSections = [...prev];
            [newSections[allIndex], newSections[targetAllIndex]] = [newSections[targetAllIndex], newSections[allIndex]];
            return newSections;
        });
        showToast(`Se√ß√£o movida para ${direction === 'up' ? 'cima' : 'baixo'}`, 'success');
    };

    // Drag and Drop handlers
    const handleDragStart = (e, id) => {
        setDraggedSectionId(id);
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', e.target);
    };

    const handleDragOver = (e, id) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        setDragOverId(id);
    };

    const handleDragLeave = () => {
        setDragOverId(null);
    };

    const handleDrop = (e, targetId) => {
        e.preventDefault();
        if (!draggedSectionId || draggedSectionId === targetId) {
            setDragOverId(null);
            setDraggedSectionId(null);
            return;
        }

        const draggedIndex = sections.findIndex(s => s.id === draggedSectionId);
        const targetIndex = sections.findIndex(s => s.id === targetId);

        if (draggedIndex !== -1 && targetIndex !== -1) {
            setSections(prev => {
                const newSections = [...prev];
                const [removed] = newSections.splice(draggedIndex, 1);
                newSections.splice(targetIndex, 0, removed);
                return newSections;
            });
            showToast('Se√ß√£o reorganizada', 'success');
        }

        setDragOverId(null);
        setDraggedSectionId(null);
    };

    // Fun√ß√µes de pastas
    const createFolder = () => {
        const name = prompt("Nome da Pasta:");
        if (name && name.trim()) {
            const newId = Date.now().toString();
            setFolders(prev => [...prev, { id: newId, name: name.trim(), expanded: true }]);
            showToast(`Pasta "${name.trim()}" criada`, 'success');
        }
    };

    const toggleFolder = (folderId) => {
        setFolders(prev => prev.map(f => f.id === folderId ? { ...f, expanded: !f.expanded } : f));
    };

    const deleteFolder = (folderId) => {
        if (confirm("Deletar esta pasta? (As se√ß√µes ser√£o movidas para fora da pasta)")) {
            setSections(prev => prev.map(s => s.folderId === folderId ? { ...s, folderId: null } : s));
            setFolders(prev => prev.filter(f => f.id !== folderId));
            showToast('Pasta removida', 'success');
        }
    };

    const moveToFolder = (sectionId, folderId) => {
        setSections(prev => prev.map(s => s.id === sectionId ? { ...s, folderId: folderId || null } : s));
        showToast(folderId ? 'Se√ß√£o movida para pasta' : 'Se√ß√£o removida da pasta', 'success');
    };

    const addSection = (folderId = null) => {
        const title = prompt("Nome da Se√ß√£o:");
        if (title && title.trim()) {
            const newId = Date.now().toString();
            setSections(prev => [...prev, { id: newId, title: title.trim(), content: `# ${title.trim()}\n\n`, folderId }]);
            setActiveSection(newId);
            showToast(`Se√ß√£o "${title.trim()}" criada`, 'info');
        }
    };

    const deleteSection = (id) => {
        if (sections.length <= 1) return alert("Precisa ter pelo menos uma se√ß√£o!");
        const sectionName = sections.find(s => s.id === id)?.title;
        if (confirm("Deletar esta se√ß√£o?")) {
            setSections(prev => prev.filter(s => s.id !== id));
            if (activeSection === id) setActiveSection(sections.find(s => s.id !== id)?.id || sections[0].id);
            showToast(`Se√ß√£o "${sectionName}" removida`, 'info');
        }
    };

    // Organizar se√ß√µes por pasta
    const getSectionsByFolder = () => {
        const sectionsWithoutFolder = sections.filter(s => !s.folderId);

        const organized = folders.map(folder => ({
            ...folder,
            sections: sections.filter(s => s.folderId === folder.id)
        }));

        return { organized, sectionsWithoutFolder };
    };

    return (
        <div className="flex-1 flex overflow-hidden relative">
            {/* Toast Notification */}
            <WriterToast {...toast} />

            {/* Luna Writing Indicator Overlay */}
            {(lunaWriting || isLunaLoading) && (
                <div className="absolute top-2 right-2 z-40 flex items-center gap-2 px-3 py-1.5 bg-violet-500/10 border border-violet-500/30 rounded-full backdrop-blur-sm luna-writing-indicator">
                    <div className="w-2 h-2 rounded-full bg-violet-400 animate-ping" />
                    <span className="text-[10px] font-bold text-violet-300 uppercase tracking-wider">Luna escrevendo...</span>
                </div>
            )}

            {/* Sidebar Se√ß√µes Melhorada */}
            <aside className={`${sidebarVisible ? 'w-64' : 'w-0'} bg-dark-900 border-r border-white/5 flex flex-col transition-all duration-300 overflow-hidden`}>
                <div className="px-3 py-2.5 text-[9px] font-bold text-white/30 uppercase tracking-widest border-b border-white/5 flex items-center justify-between bg-dark-800/50">
                    <span className="flex items-center gap-1.5">
                        <FileText size={10} className="text-emerald-400" />
                        <span>Estrutura</span>
                        <span className="ml-1 px-1.5 py-0.5 bg-white/5 rounded text-[8px] text-white/40">{sections.length}</span>
                    </span>
                    <div className="flex gap-1">
                        <button onClick={createFolder} className="text-blue-400 hover:text-blue-300 p-1 hover:bg-blue-500/10 rounded transition-all" title="Nova Pasta">
                            <FolderPlus size={12} />
                        </button>
                        <button onClick={() => addSection()} className="text-emerald-400 hover:text-emerald-300 p-1 hover:bg-emerald-500/10 rounded transition-all" title="Nova Se√ß√£o">
                            <Plus size={12} />
                        </button>
                    </div>
                </div>
                <div className="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar">
                    {(() => {
                        const { organized, sectionsWithoutFolder } = getSectionsByFolder();

                        return (
                            <>
                                {/* Pastas */}
                                {organized.map(folder => (
                                    <div key={folder.id} className="space-y-1">
                                        {/* Header da Pasta */}
                                        <div className="group flex items-center gap-2 px-2 py-1.5 rounded-lg bg-blue-500/10 border border-blue-500/20 hover:bg-blue-500/15 transition-all">
                                            <button onClick={() => toggleFolder(folder.id)} className="text-blue-400 hover:text-blue-300 transition-colors">
                                                {folder.expanded ? <ChevronDown size={12} /> : <ChevronUp size={12} className="-rotate-90" />}
                                            </button>
                                            <Folder size={12} className="text-blue-400" />
                                            <span className="flex-1 text-[11px] font-medium text-blue-300 truncate">{folder.name}</span>
                                            <div className="flex gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button onClick={(e) => { e.stopPropagation(); addSection(folder.id); }} className="text-emerald-400 hover:text-emerald-300 p-0.5" title="Adicionar se√ß√£o">
                                                    <Plus size={10} />
                                                </button>
                                                <button onClick={(e) => { e.stopPropagation(); deleteFolder(folder.id); }} className="text-red-400 hover:text-red-300 p-0.5" title="Deletar pasta">
                                                    <Trash2 size={10} />
                                                </button>
                                            </div>
                                        </div>

                                        {/* Se√ß√µes dentro da pasta */}
                                        {folder.expanded && folder.sections.map((s, idx) => (
                                            <SectionItem
                                                key={s.id}
                                                section={s}
                                                isActive={activeSection === s.id}
                                                isUpdated={updatedSectionId === s.id}
                                                isEditing={editingSectionId === s.id}
                                                editValue={editTitleValue}
                                                onEditValueChange={setEditTitleValue}
                                                onEditStart={() => startEditingTitle(s.id, s.title)}
                                                onEditSave={() => saveTitleEdit(s.id)}
                                                onEditCancel={cancelTitleEdit}
                                                onSelect={() => setActiveSection(s.id)}
                                                onDelete={() => deleteSection(s.id)}
                                                onMoveUp={() => moveSection(s.id, 'up')}
                                                onMoveDown={() => moveSection(s.id, 'down')}
                                                onDragStart={handleDragStart}
                                                onDragOver={handleDragOver}
                                                onDragLeave={handleDragLeave}
                                                onDrop={handleDrop}
                                                isDragged={draggedSectionId === s.id}
                                                isDragOver={dragOverId === s.id}
                                                canMoveUp={idx > 0}
                                                canMoveDown={idx < folder.sections.length - 1}
                                                folders={folders}
                                                currentFolderId={folder.id}
                                                onMoveToFolder={moveToFolder}
                                                indent={true}
                                            />
                                        ))}
                                    </div>
                                ))}

                                {/* Se√ß√µes sem pasta */}
                                {sectionsWithoutFolder.map((s, idx) => (
                                    <SectionItem
                                        key={s.id}
                                        section={s}
                                        isActive={activeSection === s.id}
                                        isUpdated={updatedSectionId === s.id}
                                        isEditing={editingSectionId === s.id}
                                        editValue={editTitleValue}
                                        onEditValueChange={setEditTitleValue}
                                        onEditStart={() => startEditingTitle(s.id, s.title)}
                                        onEditSave={() => saveTitleEdit(s.id)}
                                        onEditCancel={cancelTitleEdit}
                                        onSelect={() => setActiveSection(s.id)}
                                        onDelete={() => deleteSection(s.id)}
                                        onMoveUp={() => moveSection(s.id, 'up')}
                                        onMoveDown={() => moveSection(s.id, 'down')}
                                        onDragStart={handleDragStart}
                                        onDragOver={handleDragOver}
                                        onDragLeave={handleDragLeave}
                                        onDrop={handleDrop}
                                        isDragged={draggedSectionId === s.id}
                                        isDragOver={dragOverId === s.id}
                                        canMoveUp={idx > 0}
                                        canMoveDown={idx < sectionsWithoutFolder.length - 1}
                                        folders={folders}
                                        currentFolderId={null}
                                        onMoveToFolder={moveToFolder}
                                        indent={false}
                                    />
                                ))}
                            </>
                        );
                    })()}
                </div>
                <div className="p-2 border-t border-white/5 bg-dark-800/30">
                    <button onClick={onBack} className="w-full py-1.5 text-[10px] text-white/30 hover:text-white/60 hover:bg-white/5 rounded-lg flex items-center justify-center gap-1.5 transition-all">
                        <ChevronDown size={10} className="-rotate-90" />
                        Voltar ao Menu
                    </button>
                </div>
            </aside>

            {/* Editor MDEditor */}
            <div className={`flex-1 flex flex-col bg-dark-950 ${updatedSectionId === activeSection ? 'content-enter' : ''}`} data-color-mode="dark">
                {/* Header com Status */}
                <div className="px-4 py-2 border-b border-white/5 flex items-center justify-between bg-dark-900/80 backdrop-blur-sm">
                    <div className="flex items-center gap-3">
                        <button
                            onClick={() => setSidebarVisible(!sidebarVisible)}
                            className={`p-1.5 rounded-lg transition-all ${sidebarVisible ? "text-emerald-400 bg-emerald-500/10 border border-emerald-500/20" : "text-white/20 hover:text-white/40 hover:bg-white/5"}`}
                        >
                            <List size={14} />
                        </button>
                        <div className="flex items-center gap-2">
                            <Edit3 size={12} className={lunaWriting ? "text-violet-400 animate-pulse" : "text-emerald-400"} />
                            <span className="text-[12px] text-white/60 font-medium">{currentSection?.title}</span>

                            {/* Bot√µes Undo/Redo */}
                            <div className="flex items-center gap-0.5 ml-2">
                                <button
                                    onClick={handleUndo}
                                    disabled={!canUndo}
                                    className={`p-1.5 rounded-lg transition-all ${canUndo
                                        ? 'text-white/50 hover:text-white hover:bg-white/10'
                                        : 'text-white/15 cursor-not-allowed'}`}
                                    title="Desfazer (Ctrl+Z)"
                                >
                                    <ChevronDown size={14} className="-rotate-90 scale-x-[-1]" />
                                </button>
                                <button
                                    onClick={handleRedo}
                                    disabled={!canRedo}
                                    className={`p-1.5 rounded-lg transition-all ${canRedo
                                        ? 'text-white/50 hover:text-white hover:bg-white/10'
                                        : 'text-white/15 cursor-not-allowed'}`}
                                    title="Refazer (Ctrl+Y)"
                                >
                                    <ChevronDown size={14} className="rotate-90" />
                                </button>
                            </div>

                            {content.length > 0 && (
                                <span className="text-[9px] text-white/20 px-1.5 py-0.5 bg-white/5 rounded">
                                    {content.split(/\s+/).filter(Boolean).length} palavras
                                </span>
                            )}
                            <button
                                onClick={() => {
                                    if (lockedSectionId) {
                                        setLockedSectionId(null);
                                        setLockedSectionTitle(null);
                                    } else {
                                        setLockedSectionId(activeSection);
                                        const s = sections.find(ss => ss.id === activeSection);
                                        setLockedSectionTitle(s?.title || '');
                                    }
                                }}
                                className={`ml-2 px-2 py-1 rounded text-[10px] border transition-all ${lockedSectionId ? "bg-amber-500/10 border-amber-500/30 text-amber-300" : "bg-white/5 border-white/10 text-white/40 hover:text-white/70"}`}
                            >
                                {lockedSectionId ? "Se√ß√£o fixada" : "Fixar se√ß√£o"}
                            </button>
                        </div>
                    </div>
                    <div className="flex items-center gap-2">
                        {lunaWriting && (
                            <span className="text-[9px] text-violet-400 uppercase tracking-wider font-bold writer-status-active flex items-center gap-1.5">
                                <Loader2 size={10} className="animate-spin" />
                                Sincronizando
                            </span>
                        )}
                        <span className="text-[9px] text-white/20 uppercase tracking-wider font-bold flex items-center gap-1.5 px-2 py-1 bg-emerald-500/5 rounded-full border border-emerald-500/10">
                            <Sparkles size={8} className="text-emerald-400" />
                            Writer
                        </span>
                    </div>
                </div>

                {/* Quick Actions Bar - A√ß√µes r√°pidas da Luna */}
                {onQuickAction && (
                    <QuickActionsBar
                        onAction={onQuickAction}
                        disabled={isLunaLoading}
                        currentContent={content}
                    />
                )}

                {/* Editor Area */}
                <div className="flex-1 overflow-hidden" ref={editorContainerRef}>
                    <MDEditor
                        value={content}
                        onChange={handleContentChange}
                        height="100%"
                        preview="live"
                        hideToolbar={false}
                        visibleDragbar={false}
                        style={{ backgroundColor: 'transparent', height: '100%' }}
                    />
                </div>

                {/* Selection Popup - Aparece ao selecionar texto */}
                {selectedText && selectionPosition && onQuickAction && (
                    <SelectionPopup
                        selectedText={selectedText}
                        position={selectionPosition}
                        onAction={onQuickAction}
                        onClose={() => {
                            setSelectedText(null);
                            setSelectionPosition(null);
                        }}
                        disabled={isLunaLoading}
                    />
                )}
            </div>
        </div>
    );
}

// Tela de Boas-vindas / Sele√ß√£o de Projeto
function WelcomeView({ onOpenProject, onNewProject, onSelectMode, selectedMode }) {
    const [recentDocs, setRecentDocs] = useState([]);

    useEffect(() => {
        fetch(`${MEMORY_SERVER}/canvas`)
            .then(r => r.json())
            .then(data => {
                if (data.success) setRecentDocs(data.documents);
            })
            .catch(() => { });
    }, []);

    const handleLoadDoc = async (id) => {
        try {
            const res = await fetch(`${MEMORY_SERVER}/canvas/${id}`);
            const data = await res.json();
            if (data.success) {
                // Notifica o WriterView via evento ou callback se necess√°rio
                // Aqui vamos simplificar: o modo muda para writer e o App pode gerenciar o carregamento
                window.dispatchEvent(new CustomEvent('load-canvas-doc', { detail: data.document }));
                onSelectMode('writer');
            }
        } catch (e) { }
    };
    const [path, setPath] = useState("");

    // Se nenhum modo selecionado, mostra sele√ß√£o de modos
    if (!selectedMode) {
        return (
            <div className="flex-1 flex flex-col items-center justify-center bg-dark-950 p-10 text-center animate-in fade-in zoom-in-95 duration-500">
                <div className="w-20 h-20 bg-gradient-to-br from-violet-600/20 to-fuchsia-600/20 rounded-3xl flex items-center justify-center mb-6 shadow-2xl shadow-violet-500/10 border border-violet-500/20">
                    <Brain size={40} className="text-violet-400" />
                </div>
                <h1 className="text-4xl font-bold mb-2 tracking-tight bg-gradient-to-r from-white to-white/60 bg-clip-text text-transparent">Luna</h1>
                <p className="text-white/40 text-sm mb-12 max-w-md">Sua assistente de IA para c√≥digo e escrita criativa. Escolha como voc√™ quer trabalhar hoje.</p>

                <div className="grid grid-cols-2 gap-6 max-w-2xl">
                    {/* Modo IDE */}
                    <button
                        onClick={() => onSelectMode('ide')}
                        className="group relative flex flex-col items-center gap-4 p-8 bg-gradient-to-b from-white/5 to-transparent border border-white/10 rounded-3xl hover:border-violet-500/50 hover:bg-violet-500/5 transition-all duration-300 overflow-hidden"
                    >
                        <div className="absolute inset-0 bg-gradient-to-br from-violet-600/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity" />
                        <div className="w-16 h-16 bg-violet-500/20 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform">
                            <Code size={32} className="text-violet-400" />
                        </div>
                        <div>
                            <h3 className="text-xl font-bold text-white mb-2">Modo IDE</h3>
                            <p className="text-white/40 text-xs max-w-[180px]">Crie e edite projetos de c√≥digo com a ajuda da Luna</p>
                        </div>
                        <span className="text-[10px] uppercase tracking-widest text-violet-400 font-bold mt-2">Come√ßar ‚Üí</span>
                    </button>

                    {/* Modo Writer */}
                    <button
                        onClick={() => onSelectMode('writer')}
                        className="group relative flex flex-col items-center gap-4 p-8 bg-gradient-to-b from-white/5 to-transparent border border-white/10 rounded-3xl hover:border-emerald-500/50 hover:bg-emerald-500/5 transition-all duration-300 overflow-hidden"
                    >
                        <div className="absolute inset-0 bg-gradient-to-br from-emerald-600/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity" />
                        <div className="w-16 h-16 bg-emerald-500/20 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform">
                            <MessageSquare size={32} className="text-emerald-400" />
                        </div>
                        <div>
                            <h3 className="text-xl font-bold text-white mb-2">Modo Writer</h3>
                            <p className="text-white/40 text-xs max-w-[180px]">Escreva livros, artigos e documentos com a Luna</p>
                        </div>
                        <span className="text-[10px] uppercase tracking-widest text-emerald-400 font-bold mt-2">Come√ßar ‚Üí</span>
                    </button>
                </div>
            </div>
        );
    }

    // Modo IDE selecionado - mostra picker de projeto
    return (
        <div className="flex-1 flex flex-col items-center justify-center bg-dark-950 p-10 text-center animate-in fade-in zoom-in-95 duration-500">
            <button
                onClick={() => onSelectMode(null)}
                className="absolute top-20 left-6 text-white/30 hover:text-white/60 text-xs flex items-center gap-2 transition-colors"
            >
                ‚Üê Voltar
            </button>

            <div className="w-16 h-16 bg-violet-600/20 rounded-2xl flex items-center justify-center mb-6 shadow-2xl shadow-violet-500/10 border border-violet-500/20">
                <Code size={32} className="text-violet-500" />
            </div>
            <h1 className="text-2xl font-bold mb-2 tracking-tight">Modo IDE</h1>
            <p className="text-white/40 text-sm mb-8 max-w-sm">Abra um projeto existente ou crie um novo.</p>

            <div className="w-full max-w-md space-y-4">
                <div className="flex flex-col gap-2">
                    <label className="text-[10px] uppercase tracking-widest text-white/20 font-bold self-start ml-2">Abrir Pasta do Projeto</label>
                    <div className="flex gap-2">
                        <div className="flex-1 relative group">
                            <input
                                type="text"
                                value={path}
                                onChange={(e) => setPath(e.target.value)}
                                placeholder="Ex: C:\MeusProjetos\Luna"
                                className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 pr-12 text-sm text-white placeholder-white/10 outline-none focus:border-violet-500/50 transition-colors"
                            />
                            <button
                                onClick={async () => {
                                    const res = await fetch(`${MEMORY_SERVER}/system/pick-folder`);
                                    const data = await res.json();
                                    if (data.success) setPath(data.path);
                                }}
                                className="absolute right-3 top-1/2 -translate-y-1/2 text-white/20 hover:text-white/60 transition-colors p-1"
                                title="Procurar Pasta"
                            >
                                <Folder size={16} />
                            </button>
                        </div>
                        <button
                            onClick={() => onOpenProject(path)}
                            disabled={!path.trim()}
                            className="bg-violet-600 hover:bg-violet-500 disabled:opacity-50 px-6 py-3 rounded-xl font-bold text-sm transition-all"
                        >
                            Abrir
                        </button>
                    </div>
                </div>

                <div className="pt-6 grid grid-cols-2 gap-4">
                    <button
                        onClick={onNewProject}
                        className="flex flex-col items-center gap-3 p-4 bg-white/5 border border-white/5 rounded-2xl hover:bg-white/10 transition-colors"
                    >
                        <FolderTree size={20} className="text-emerald-400" />
                        <span className="text-xs font-bold text-white/60 uppercase tracking-widest">Novo Projeto</span>
                    </button>
                    <button className="flex flex-col items-center gap-3 p-4 bg-white/5 border border-white/5 rounded-2xl hover:bg-white/10 transition-colors opacity-50 cursor-not-allowed">
                        <Sparkles size={20} className="text-amber-400" />
                        <span className="text-xs font-bold text-white/60 uppercase tracking-widest">Recentes</span>
                    </button>
                </div>
            </div>

            {/* Recent Canvas Documents */}
            {recentDocs.length > 0 && selectedMode === 'writer' && (
                <div className="mt-12 w-full max-w-4xl animate-in fade-in slide-in-from-bottom-4 duration-1000 delay-300">
                    <h3 className="text-[10px] font-bold text-white/20 uppercase tracking-[0.2em] mb-4 text-center">Documentos Recentes</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        {recentDocs.slice(0, 6).map(doc => (
                            <div
                                key={doc.id}
                                onClick={() => handleLoadDoc(doc.id)}
                                className="group p-4 bg-white/5 border border-white/5 rounded-2xl hover:bg-white/10 hover:border-violet-500/30 transition-all cursor-pointer"
                            >
                                <div className="flex items-start gap-3">
                                    <div className="p-2 bg-emerald-500/10 rounded-lg group-hover:bg-emerald-500/20 transition-colors">
                                        <FileText size={16} className="text-emerald-400" />
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <h4 className="text-sm font-medium text-white/80 truncate group-hover:text-white transition-colors">{doc.title}</h4>
                                        <p className="text-[10px] text-white/30 truncate mt-1">{doc.preview || "Sem conte√∫do"}</p>
                                        <div className="flex items-center gap-2 mt-2">
                                            <span className="text-[9px] text-white/20 uppercase tracking-tighter">
                                                {new Date(doc.updated_at).toLocaleDateString()}
                                            </span>
                                            <div className="w-1 h-1 rounded-full bg-white/10" />
                                            <span className="text-[9px] text-white/20 uppercase tracking-tighter">
                                                {doc.section_count} se√ß√µes
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )}
        </div>
    );
}

// Componente de Editor de C√≥digo (Interativo com Monaco)
function CodeEditor({ file, content, onChange, onSave, onClose }) {
    if (!file) return (
        <div className="flex-1 flex flex-col items-center justify-center text-white/10 opacity-50">
            <Code size={48} className="mb-4" />
            <p className="text-sm font-medium tracking-widest">LUNA CODE VIEWER</p>
            <p className="text-xs">Selecione um arquivo para visualizar</p>
        </div>
    );

    const getLanguage = (fileName) => {
        if (!fileName) return 'plaintext';
        const ext = fileName.split('.').pop();
        if (ext === 'py') return 'python';
        if (ext === 'js' || ext === 'jsx') return 'javascript';
        if (ext === 'html') return 'html';
        if (ext === 'css') return 'css';
        if (ext === 'json') return 'json';
        return 'plaintext';
    };

    return (
        <div className="flex-1 flex flex-col bg-[#0b0e14] border-r border-white/5 overflow-hidden animate-in fade-in zoom-in-95 duration-300">
            {/* Tab Header */}
            <div className="flex items-center justify-between px-4 py-2 bg-[#161b22] border-b border-white/5">
                <div className="flex items-center gap-2">
                    <File size={14} className="text-blue-400" />
                    <span className="text-xs text-white/80 font-mono italic">{file?.name || "Sem Nome"}</span>
                </div>
                <div className="flex items-center gap-3">
                    <button
                        onClick={onSave}
                        className="text-[10px] font-bold uppercase tracking-widest bg-emerald-500/10 text-emerald-400 px-2 py-1 rounded border border-emerald-500/20 hover:bg-emerald-500/20 transition-all flex items-center gap-1.5"
                    >
                        <Sparkles size={10} />
                        Salvar
                    </button>
                    <button onClick={onClose} className="p-1 hover:bg-white/5 rounded text-white/30 hover:text-white/60">
                        <X size={14} />
                    </button>
                </div>
            </div>

            {/* Editor Area (Monaco) */}
            <div className="flex-1">
                <Editor
                    height="100%"
                    theme="vs-dark"
                    language={getLanguage(file?.name)}
                    value={content}
                    onChange={onChange}
                    options={{
                        fontSize: 13,
                        minimap: { enabled: false },
                        scrollBeyondLastLine: false,
                        automaticLayout: true,
                        padding: { top: 16 },
                        fontFamily: "'Fira Code', 'Courier New', monospace",
                        renderLineHighlight: "all",
                        cursorBlinking: "smooth",
                        cursorSmoothCaretAnimation: "on"
                    }}
                />
            </div>
        </div>
    );
}

// Markdown renderer
const MarkdownContent = ({ content }) => (
    <ReactMarkdown
        remarkPlugins={[remarkGfm]}
        components={{
            code({ node, inline, className, children, ...props }) {
                const match = /language-(\w+)/.exec(className || "");
                return !inline && match ? (
                    <SyntaxHighlighter
                        style={oneDark}
                        language={match[1]}
                        PreTag="div"
                        customStyle={{
                            margin: "0.5rem 0",
                            padding: "0.75rem",
                            borderRadius: "8px",
                            fontSize: "0.8rem",
                            background: "#1e1e2e",
                        }}
                        {...props}
                    >
                        {String(children).replace(/\n$/, "")}
                    </SyntaxHighlighter>
                ) : (
                    <code className="bg-dark-800 px-1 py-0.5 rounded text-pink-400 font-mono text-xs" {...props}>
                        {children}
                    </code>
                );
            },
        }}
    >
        {content}
    </ReactMarkdown>
);

// Componente de Bloco de Pesquisa Web
function SearchBlock({ action }) {
    if (!action || !action.call) return null;
    const { call, result } = action;
    const query = call.args.query || "Pesquisando...";

    return (
        <div className="my-3 bg-[#0d1117] border border-blue-500/30 rounded-lg overflow-hidden shadow-lg animate-in fade-in slide-in-from-bottom-2 duration-300">
            {/* Header */}
            <div className="flex items-center gap-2 px-3 py-2 bg-blue-500/10 border-b border-blue-500/20">
                <div className={`p-1.5 rounded-full bg-blue-500/20 text-blue-400 ${!result ? "animate-spin" : ""}`}>
                    <Globe size={14} />
                </div>
                <div className="flex-1 min-w-0">
                    <p className="text-[11px] font-bold text-blue-300 uppercase tracking-wider">Luna Search</p>
                    <p className="text-[12px] text-white/70 truncate">"{query}"</p>
                </div>
                {result && (
                    <div className="text-[10px] text-white/30 font-mono">
                        {result.success ? "Conclu√≠do" : "Falhou"}
                    </div>
                )}
            </div>

            {/* Content (Resultados) */}
            {result && result.success && (
                <div className="p-3 bg-[#0d1117]/50 max-h-60 overflow-y-auto custom-scrollbar">
                    <div className="text-[11px] text-white/80 whitespace-pre-wrap leading-relaxed font-mono">
                        {typeof result.content === 'string'
                            ? result.content.split('\n\n').map((block, idx) => {
                                if (block.includes("TITULO:")) {
                                    // Tenta formatar bonitinho se seguir o padr√£o do tools.py
                                    const lines = block.split('\n');
                                    const title = lines.find(l => l.startsWith("TITULO:"))?.replace("TITULO:", "").trim();
                                    const link = lines.find(l => l.startsWith("LINK:"))?.replace("LINK:", "").trim();
                                    const resumo = lines.find(l => l.startsWith("RESUMO:"))?.replace("RESUMO:", "").trim();

                                    if (title && link) {
                                        return (
                                            <div key={idx} className="mb-3 p-2 rounded bg-white/5 border border-white/5 hover:border-blue-500/30 transition-colors last:mb-0">
                                                <a href={link} target="_blank" rel="noopener noreferrer" className="block text-blue-400 hover:text-blue-300 font-bold mb-1 truncate hover:underline">{title}</a>
                                                <div className="text-white/30 text-[10px] truncate mb-1">{link}</div>
                                                <p className="text-white/60">{resumo}</p>
                                            </div>
                                        );
                                    }
                                }
                                return <div key={idx} className="mb-2 last:mb-0">{block}</div>;
                            })
                            : JSON.stringify(result.content, null, 2)
                        }
                    </div>
                </div>
            )}

            {result && !result.success && (
                <div className="p-3 text-red-400 text-xs">‚ùå {result.error || "Erro desconhecido na busca"}</div>
            )}
        </div>
    );
}

// Componente de Bloco de Leitura Web (Reader)
function ReaderBlock({ action }) {
    if (!action || !action.call) return null;
    const { call, result } = action;
    const url = call.args.url || "Lendo URL...";

    return (
        <div className="my-3 bg-[#0d1117] border border-emerald-500/30 rounded-lg overflow-hidden shadow-lg animate-in fade-in slide-in-from-bottom-2 duration-300">
            {/* Header */}
            <div className="flex items-center gap-2 px-3 py-2 bg-emerald-500/10 border-b border-emerald-500/20">
                <div className={`p-1.5 rounded-full bg-emerald-500/20 text-emerald-400 ${!result ? "animate-spin" : ""}`}>
                    <FileText size={14} />
                </div>
                <div className="flex-1 min-w-0">
                    <p className="text-[11px] font-bold text-emerald-300 uppercase tracking-wider">Luna Reader</p>
                    <p className="text-[12px] text-white/70 truncate">{result?.title || url}</p>
                </div>
                {result && (
                    <div className="text-[10px] text-white/30 font-mono">
                        {result.success ? "Leitura Conclu√≠da" : "Falhou"}
                    </div>
                )}
            </div>

            {/* Content (Conte√∫do Extra√≠do) */}
            {result && result.success && (
                <div className="p-3 bg-[#0d1117]/50 max-h-60 overflow-y-auto custom-scrollbar">
                    <div className="text-[11px] text-white/80 whitespace-pre-wrap leading-relaxed font-mono">
                        {result.content}
                    </div>
                </div>
            )}

            {result && !result.success && (
                <div className="p-3 text-red-400 text-xs">‚ùå {result.error || "Erro ao ler a URL"}</div>
            )}
        </div>
    );
}

// Componente elegante para a√ß√µes do Modo Writer
function WriterBlock({ action }) {
    if (!action || !action.call) return null;
    const { call, result } = action;

    const sectionTitle = call.args?.section_title || "documento";
    const mode = call.args?.mode || "replace";
    const isWriting = !result;
    const isSuccess = result?.success;

    return (
        <div className="my-2 animate-in fade-in slide-in-from-bottom-2 duration-500">
            <div className={`relative overflow-hidden rounded-2xl border backdrop-blur-md transition-all ${isWriting
                ? "bg-gradient-to-r from-violet-600/10 via-fuchsia-600/10 to-violet-600/10 border-violet-500/30 shadow-[0_0_30px_-10px_rgba(139,92,246,0.3)]"
                : isSuccess
                    ? "bg-emerald-950/30 border-emerald-500/20 shadow-lg"
                    : "bg-red-950/30 border-red-500/20"
                }`}>
                {/* Barra de Progresso Animada */}
                {isWriting && (
                    <div className="absolute top-0 left-0 right-0 h-[1px] bg-gradient-to-r from-transparent via-violet-400 to-transparent opacity-50 animate-shimmer" />
                )}

                <div className="flex items-center gap-4 p-4">
                    {/* √çcone de Status */}
                    <div className={`p-3 rounded-xl flex-shrink-0 transition-all duration-500 ${isWriting
                        ? "bg-violet-500/20 text-violet-300 shadow-[0_0_15px_rgba(139,92,246,0.4)] animate-pulse"
                        : isSuccess
                            ? "bg-emerald-500/10 text-emerald-400"
                            : "bg-red-500/10 text-red-400"
                        }`}>
                        {isWriting ? <Sparkles size={20} className="animate-spin-slow" /> :
                            isSuccess ? <Check size={20} /> : <X size={20} />}
                    </div>

                    <div className="flex-1 min-w-0">
                        {/* T√≠tulo da A√ß√£o */}
                        <div className="flex items-center gap-2 mb-0.5">
                            <span className={`text-xs font-bold uppercase tracking-widest ${isWriting ? "text-violet-300" : isSuccess ? "text-emerald-400" : "text-red-400"
                                }`}>
                                {isWriting ? "Escrevendo..." : isSuccess ? "Conclu√≠do" : "Falha"}
                            </span>
                            {isWriting && <span className="flex gap-0.5">
                                <span className="w-1 h-1 rounded-full bg-violet-400 animate-bounce delay-0"></span>
                                <span className="w-1 h-1 rounded-full bg-violet-400 animate-bounce delay-100"></span>
                                <span className="w-1 h-1 rounded-full bg-violet-400 animate-bounce delay-200"></span>
                            </span>}
                        </div>

                        {/* Descri√ß√£o Amig√°vel */}
                        <p className="text-sm text-white/90 font-medium truncate">
                            {call.name === "write_document" && (sectionTitle ? `Atualizando se√ß√£o "${sectionTitle}"` : "Atualizando documento")}
                            {call.name === "rename_document_section" && `Renomeando se√ß√£o para "${call.args.new_title}"`}
                            {call.name === "delete_document_section" && `Removendo se√ß√£o "${sectionTitle}"`}
                        </p>

                        {/* Detalhes sutis */}
                        {isSuccess && call.name === "write_document" && (
                            <p className="text-[10px] text-white/40 mt-1 flex items-center gap-1.5">
                                <FileText size={10} />
                                <span>Conte√∫do sincronizado com o Canvas</span>
                            </p>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
}

// Componente de Terminal para exibir ferramentas
function TerminalBlock({ action }) {
    if (!action || !action.call) return null;
    const { call, result } = action;

    // Se for busca web, usa o bloco visual espec√≠fico
    if (call.name === "web_search") {
        return <SearchBlock action={action} />;
    }

    // Se for leitura de URL, usa o bloco visual espec√≠fico
    if (call.name === "read_url") {
        return <ReaderBlock action={action} />;
    }

    // Se for a√ß√£o do Modo Writer, usa o bloco elegante
    if (["write_document", "rename_document_section", "delete_document_section"].includes(call.name)) {
        return <WriterBlock action={action} />;
    }

    return (
        <div className="my-3 font-mono bg-[#0d1117] border border-white/10 rounded-lg overflow-hidden shadow-xl animate-in fade-in slide-in-from-bottom-2 duration-300">
            {/* Header */}
            <div className="flex items-center justify-between px-3 py-1.5 bg-[#161b22] border-b border-white/5">
                <div className="flex gap-1.5">
                    <div className="w-2.5 h-2.5 rounded-full bg-[#ff5f56]"></div>
                    <div className="w-2.5 h-2.5 rounded-full bg-[#ffbd2e]"></div>
                    <div className="w-2.5 h-2.5 rounded-full bg-[#27c93f]"></div>
                </div>
                <div className="text-[10px] text-white/30 uppercase tracking-widest font-bold">
                    Terminal ‚Äî {call.name}
                </div>
            </div>

            {/* Content */}
            <div className="p-3 text-[12px] leading-relaxed overflow-x-auto">
                <div className="flex gap-2 text-violet-400 mb-1">
                    <span className="text-blue-400 font-bold">‚ûú</span>
                    <span className="text-white/90">
                        {call.name}({Object.entries(call.args || {}).map(([k, v]) => `${k}="${v}"`).join(", ")})
                    </span>
                </div>

                {result ? (
                    <div className="mt-2 pt-2 border-t border-white/5">
                        <pre className={`whitespace-pre-wrap ${result.success ? "text-green-400/90" : "text-red-400/90"}`}>
                            {result.success
                                ? (typeof result.data === 'string' ? result.data : JSON.stringify(result.data, null, 2))
                                : `Erro: ${result.error}`
                            }
                        </pre>
                    </div>
                ) : (
                    <div className="flex items-center gap-2 text-white/30 italic mt-2 animate-pulse">
                        <Loader2 size={10} className="animate-spin" />
                        <span>Processando comando...</span>
                    </div>
                )}
            </div>
        </div>
    );
}

function App() {
    const [input, setInput] = useState("");
    const [messages, setMessages] = useState([
        {
            role: "assistant",
            events: [{ type: "text", content: "Oi, Ethan... que bom te ver. Vamos codar? Me diga qual pasta voc√™ quer abrir." }]
        },
    ]);
    const [isLoading, setIsLoading] = useState(false);
    const [currentPhase, setCurrentPhase] = useState(null);
    const [streamingEvents, setStreamingEvents] = useState([]); // Timeline √∫nica em tempo real
    const streamingEventsRef = useRef([]); // Ref para o estado atualizado dentro do loop de streaming
    const [memoryCount, setMemoryCount] = useState(0);
    const [agentMode, setAgentMode] = useState(true);

    // Estados de Modo da Aplica√ß√£o
    const [appMode, setAppMode] = useState(null); // null | 'ide' | 'writer'

    // Estados de Chat e Sidebar
    const [sidebarTab, setSidebarTab] = useState("files"); // 'files' | 'chats'
    const [currentChatId, setCurrentChatId] = useState(null);
    const [currentThreadId, setCurrentThreadId] = useState(null);

    // Estados VS Code (IDE Mode)
    const [projectRoot, setProjectRoot] = useState(null);
    const [fileTree, setFileTree] = useState([]);
    const [activeFile, setActiveFile] = useState(null);
    const [activeFileContent, setActiveFileContent] = useState("");
    const [sidebarVisible, setSidebarVisible] = useState(true);
    const [selectedImage, setSelectedImage] = useState(null);
    const [imagePreview, setImagePreview] = useState(null);

    // Contexto do documento (Modo Writer)
    const [documentContext, setDocumentContext] = useState(null);

    const fileInputRef = useRef(null);
    const messagesEndRef = useRef(null);
    const inputRef = useRef(null);

    // Atualiza a ref sempre que streamingEvents muda
    useEffect(() => {
        streamingEventsRef.current = streamingEvents;
    }, [streamingEvents]);

    useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    }, [messages, streamingEvents]);

    useEffect(() => {
        inputRef.current?.focus();
        fetch(`${MEMORY_SERVER}/memory/count`).then(r => r.json()).then(d => setMemoryCount(d.count)).catch(() => { });
    }, []);

    // Carregamento de Chats
    const [chats, setChats] = useState([]);

    const loadChats = async () => {
        try {
            const res = await fetch(`${MEMORY_SERVER}/chats`);
            const data = await res.json();
            if (data.success) setChats(data.chats);
        } catch { }
    };

    useEffect(() => {
        loadChats();
    }, []);

    // Auto-save Chat Effect (com suporte a threads)
    useEffect(() => {
        if (!isLoading && messages.length > 0) {
            const timeoutId = setTimeout(async () => {
                const hasUserMsg = messages.some(m => m.role === 'user');
                if (!currentChatId && !hasUserMsg) return;

                try {
                    const res = await fetch(`${MEMORY_SERVER}/chats`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            chat_id: currentChatId,
                            thread_id: currentThreadId, // Salva na thread se houver
                            messages: messages,
                            title: null
                        })
                    });
                    const data = await res.json();
                    if (data.success) {
                        if (!currentChatId) {
                            setCurrentChatId(data.chat.id);
                        }
                        // Recarrega a lista de chats para garantir que o novo chat apare√ßa
                        loadChats();
                    }
                } catch { }
            }, 2000);

            return () => clearTimeout(timeoutId);
        }
    }, [messages, isLoading, currentChatId, currentThreadId]);

    const handleLoadChat = async (id) => {
        try {
            const res = await fetch(`${MEMORY_SERVER}/chats/${id}`);
            const data = await res.json();
            if (data.success) {
                setMessages(data.chat.messages || []);
                setCurrentChatId(data.chat.id);
                setCurrentThreadId(null); // Limpa thread ao carregar chat principal
                setStreamingEvents([]);
            }
        } catch { }
    };

    const handleLoadThread = async (chatId, threadId) => {
        try {
            const res = await fetch(`${MEMORY_SERVER}/chats/${chatId}?thread_id=${threadId}`);
            const data = await res.json();
            if (data.success && data.chat.thread) {
                setMessages(data.chat.thread.messages || [{ role: "assistant", events: [{ type: "text", content: "Nova thread iniciada! O que vamos discutir aqui?" }] }]);
                setCurrentChatId(chatId);
                setCurrentThreadId(threadId);
                setStreamingEvents([]);
            }
        } catch { }
    };

    const handleNewChat = () => {
        setMessages([{
            role: "assistant",
            events: [{ type: "text", content: "Ol√°! Novo contexto iniciado. Como posso ajudar com seu c√≥digo hoje?" }]
        }]);
        setCurrentChatId(null);
        setCurrentThreadId(null);
        setStreamingEvents([]);
    };

    const handleImageSelect = (e) => {
        const file = e.target.files[0];
        if (file) {
            processImageFile(file);
        }
    };

    const processImageFile = (file) => {
        const reader = new FileReader();
        reader.onloadend = () => {
            setImagePreview(reader.result);
            // Remove o prefixo data:image/...;base64,
            const base64 = reader.result.split(',')[1];
            setSelectedImage(base64);
        };
        reader.readAsDataURL(file);
    };

    const handlePaste = (e) => {
        const items = e.clipboardData?.items;
        if (items) {
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf("image") !== -1) {
                    const blob = items[i].getAsFile();
                    processImageFile(blob);
                    break;
                }
            }
        }
    };

    const sendMessage = async () => {
        if ((!input.trim() && !selectedImage) || isLoading) return;

        const userMessage = {
            role: "user",
            content: input.trim(),
            image: selectedImage
        };
        const newMessages = [...messages, userMessage];

        setMessages(newMessages);
        setInput("");
        setSelectedImage(null);
        setImagePreview(null);
        setIsLoading(true);
        setCurrentPhase(null);
        setStreamingEvents([]);

        try {
            const endpoint = agentMode ? "/agent/stream" : "/chat/stream";
            const docContext = appMode === 'writer' ? documentContext : null;
            if (docContext) {
                console.log('[Writer] Enviando document_context:', {
                    activeSectionId: docContext.activeSectionId,
                    sectionTitle: docContext.sectionTitle,
                    sectionsCount: docContext.sections?.length
                });
            }
            const response = await fetch(`${MEMORY_SERVER}${endpoint}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    messages: newMessages.map(m => {
                        // Se n√£o tem content direto, tenta reconstruir dos events (timeline)
                        let textContent = m.content || "";
                        if (!textContent && m.events) {
                            textContent = m.events
                                .filter(e => e.type === "text")
                                .map(e => e.content)
                                .join("\n");
                        }
                        return {
                            role: m.role,
                            content: textContent,
                            image: m.image || null
                        };
                    }),
                    agent_mode: agentMode,
                    code_context: activeFileContent,
                    active_file: activeFile?.path || null,
                    document_context: docContext
                }),
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const lines = decoder.decode(value).split("\n");
                for (const line of lines) {
                    if (!line.startsWith("data: ")) continue;
                    try {
                        const data = JSON.parse(line.slice(6));

                        if (data.phase) {
                            setCurrentPhase(data.phase);
                        }

                        if (data.thinking) {
                            setStreamingEvents(prev => {
                                const last = prev[prev.length - 1];
                                if (last && last.type === "thought") {
                                    return [...prev.slice(0, -1), { ...last, content: last.content + data.thinking, isActive: true }];
                                }
                                return [...prev, { type: "thought", content: data.thinking, isActive: true }];
                            });
                        }

                        if (data.content) {
                            setStreamingEvents(prev => {
                                const last = prev[prev.length - 1];
                                if (last && last.type === "thought") last.isActive = false; // Finaliza pensamento se chegou texto
                                if (last && last.type === "text") {
                                    return [...prev.slice(0, -1), { ...last, content: last.content + data.content }];
                                }
                                return [...prev, { type: "text", content: data.content }];
                            });
                        }

                        if (data.status) {
                            setCurrentPhase(data.status);
                        }

                        if (data.tool_call) {
                            setStreamingEvents(prev => {
                                const last = prev[prev.length - 1];
                                if (last && last.type === "thought") last.isActive = false;
                                return [...prev, { type: "action", call: data.tool_call, result: null }];
                            });
                        }

                        if (data.tool_result) {
                            setStreamingEvents(prev => {
                                const next = [...prev];
                                const lastActionIdx = [...next].reverse().findIndex(e => e.type === "action");
                                if (lastActionIdx !== -1) {
                                    const idx = next.length - 1 - lastActionIdx;
                                    next[idx].result = data.tool_result;

                                    // Monitora tool_results espec√≠ficos para atualizar UI
                                    const toolName = next[idx].call.name;
                                    if (toolName === "open_project" && data.tool_result.success) {
                                        setProjectRoot(normalizePath(data.tool_result.root));
                                        setFileTree(data.tool_result.tree);
                                    }
                                    if (toolName === "list_dir" && data.tool_result.success) {
                                        // Se foi uma listagem de subpasta, atualiza recursivamente
                                        setFileTree(prev => updateTreeRecursive(prev, next[idx].call.args.path, data.tool_result.items));
                                    }
                                    if (toolName === "read_file" && data.tool_result.success) {
                                        const path = normalizePath(next[idx].call.args.path);
                                        setActiveFile({ name: path.split('/').pop(), path: path });
                                        setActiveFileContent(data.tool_result.content);
                                    }
                                    if (toolName === "write_file" && data.tool_result.success) {
                                        // Se editou o arquivo aberto, atualiza visualmente
                                        if (activeFile?.path === next[idx].call.args.path) {
                                            setActiveFileContent(next[idx].call.args.content);
                                        }
                                        // Sempre tenta atualizar a √°rvore pois pode ser um arquivo novo
                                        refreshFileTree();
                                    }
                                    if ((toolName === "create_folder" || toolName === "run_command") && data.tool_result.success) {
                                        refreshFileTree();
                                    }
                                    // Handler para tools do Modo Writer (Canvas)
                                    if (["write_document", "rename_document_section", "delete_document_section"].includes(toolName)) {
                                        console.log('[Writer] Tool chamada:', toolName, 'Resultado:', data.tool_result);
                                        if (data.tool_result && data.tool_result.success) {
                                            window.dispatchEvent(new CustomEvent('luna-document-update', {
                                                detail: data.tool_result
                                            }));
                                        } else {
                                            console.warn('[Writer] Tool falhou:', data.tool_result);
                                        }
                                    }
                                }
                                return next;
                            });
                        }

                        if (data.done) {
                            setMessages(prev => [...prev, {
                                role: "assistant",
                                events: [...streamingEventsRef.current]
                            }]);
                            setStreamingEvents([]);
                            setCurrentPhase(null);
                            fetch(`${MEMORY_SERVER}/memory/count`).then(r => r.json()).then(d => setMemoryCount(d.count)).catch(() => { });
                        }
                    } catch (e) {
                        console.error("Erro no parse:", e);
                    }
                }
            }
        } catch (error) {
            setMessages(prev => [...prev, { role: "assistant", events: [{ type: "text", content: `‚ùå Erro: ${error.message}` }] }]);
        } finally {
            setIsLoading(false);
            inputRef.current?.focus();
        }
    };

    const renderEvents = (events) => {
        return events.map((ev, idx) => {
            if (ev.type === "thought") return <ThinkingPanel key={idx} thinking={ev.content} isActive={ev.isActive} MarkdownRenderer={MarkdownContent} />;
            if (ev.type === "action") return <TerminalBlock key={idx} action={ev} />;
            if (ev.type === "text") return (
                <div key={idx} className="markdown-content text-sm mt-1">
                    <MarkdownContent content={ev.content} />
                </div>
            );
            return null;
        });
    };

    const handleToggleFolder = async (folder) => {
        if (folder.children) return; // J√° carregado

        try {
            const response = await fetch(`${MEMORY_SERVER}/chat/stream`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    messages: [{ role: "user", content: `Luna, liste o conte√∫do da pasta: ${folder.path}` }],
                    agent_mode: true
                }),
            });
            // O streaming vai atualizar o fileTree recursivamente via tool_result
        } catch { }
    };

    // Fun√ß√£o utilit√°ria para normalizar caminhos (evita problemas de barras no Windows)
    const normalizePath = (p) => {
        if (!p) return p;
        return p.replace(/\\/g, '/');
    };

    // Fun√ß√£o auxiliar para atualizar pasta na √°rvore recursiva
    const updateTreeRecursive = (tree, path, children) => {
        const normPath = normalizePath(path);
        return tree.map(item => {
            if (normalizePath(item.path) === normPath) return { ...item, children };
            if (item.type === "dir" && item.children) {
                return { ...item, children: updateTreeRecursive(item.children, path, children) };
            }
            return item;
        });
    };

    const handleOpenProject = async (path) => {
        setIsLoading(true);
        setCurrentPhase("Abrindo projeto...");
        try {
            const response = await fetch(`${MEMORY_SERVER}/project/open`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ path }),
            });
            const data = await response.json();
            if (data.success) {
                setProjectRoot(normalizePath(data.root));
                setFileTree(data.tree);
                setMessages(prev => [...prev, { role: "assistant", events: [{ type: "text", content: `üìÇ Projeto aberto: **${data.root}**` }] }]);
            } else {
                setMessages(prev => [...prev, { role: "assistant", events: [{ type: "text", content: `‚ùå Erro ao abrir projeto: ${data.error}` }] }]);
            }
        } catch (e) {
            setMessages(prev => [...prev, { role: "assistant", events: [{ type: "text", content: `‚ùå Erro de conex√£o: ${e.message}` }] }]);
        } finally {
            setIsLoading(false);
            setCurrentPhase(null);
        }
    };

    const handleNewProject = async () => {
        // Primeiro escolhe ONDE criar
        const pickRes = await fetch(`${MEMORY_SERVER}/system/pick-folder`);
        const pickData = await pickRes.json();

        if (!pickData.success) return;

        const baseDir = pickData.path;
        const projectName = window.prompt("Nome do novo projeto:");
        if (!projectName) return;

        const fullPath = `${baseDir}\\${projectName}`;

        setIsLoading(true);
        setCurrentPhase("Criando projeto...");
        try {
            const response = await fetch(`${MEMORY_SERVER}/project/create`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ path: fullPath }),
            });
            const data = await response.json();
            if (data.success) {
                setProjectRoot(normalizePath(data.root));
                setFileTree(data.tree);
                setMessages(prev => [...prev, { role: "assistant", events: [{ type: "text", content: `‚ú® Projeto criado e aberto: **${data.root}**` }] }]);
            } else {
                setMessages(prev => [...prev, { role: "assistant", events: [{ type: "text", content: `‚ùå Erro ao criar projeto: ${data.error}` }] }]);
            }
        } catch (e) {
            setMessages(prev => [...prev, { role: "assistant", events: [{ type: "text", content: `‚ùå Erro de conex√£o: ${e.message}` }] }]);
        } finally {
            setIsLoading(false);
            setCurrentPhase(null);
        }
    };

    const handleSaveFile = async () => {
        if (!activeFile) return;
        setIsLoading(true);
        setCurrentPhase("Salvando arquivo...");
        try {
            const response = await fetch(`${MEMORY_SERVER}/project/save`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ path: activeFile.path, content: activeFileContent }),
            });
            const data = await response.json();
            if (data.success) {
                setMessages(prev => [...prev, { role: "assistant", events: [{ type: "text", content: `‚úîÔ∏è Arquivo salvo: **${activeFile.name}**` }] }]);
            } else {
                setMessages(prev => [...prev, { role: "assistant", events: [{ type: "text", content: `‚ùå Erro ao salvar: ${data.error}` }] }]);
            }
        } catch (e) {
            setMessages(prev => [...prev, { role: "assistant", events: [{ type: "text", content: `‚ùå Erro de salvamento: ${e.message}` }] }]);
        } finally {
            setIsLoading(false);
            setCurrentPhase(null);
        }
    };

    // Atalho Ctrl+S
    useEffect(() => {
        const handleKeyDown = (e) => {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                handleSaveFile();
            }
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
    }, [activeFile, activeFileContent]);

    const refreshFileTree = async () => {
        if (!projectRoot) return;
        try {
            const response = await fetch(`${MEMORY_SERVER}/project/open`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ path: projectRoot }),
            });
            const data = await response.json();
            if (data.success) {
                setFileTree(data.tree);
            }
        } catch (e) {
            console.error("Erro ao atualizar √°rvore:", e);
        }
    };

    const handleFileClick = async (file) => {
        setIsLoading(true);
        setCurrentPhase("Lendo arquivo...");
        try {
            const response = await fetch(`${MEMORY_SERVER}/chat/stream`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    messages: [{ role: "user", content: `Luna, leia o arquivo ${file.path} para mim.` }],
                    agent_mode: true
                }),
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const lines = decoder.decode(value).split("\n");
                for (const line of lines) {
                    if (!line.startsWith("data: ")) continue;
                    try {
                        const data = JSON.parse(line.slice(6));

                        // Atualiza status global se necess√°rio
                        if (data.status) setCurrentPhase(data.status);

                        // Processa tool_result para atualizar a UI do editor
                        if (data.tool_result) {
                            // Se o resultado for de uma leitura de arquivo, atualiza o editor
                            // A Luna pode chamar read_file como parte do processo
                            // Precisamos verificar se o resultado tem 'content' e se parece ser o arquivo pedido
                            if (data.tool_result.success && data.tool_result.content) {
                                // Como n√£o temos o nome da tool aqui direto (estaria no tool_call anterior), 
                                // assumimos que se vier conte√∫do de texto longo, √© o arquivo.
                                // Mas o ideal √© ver se bate com o path.
                                // O backend retorna 'path' no read_file? Vamos assumir que sim ou confiar no fluxo.
                                if (data.tool_result.success) {
                                    setActiveFile({ name: file.name, path: file.path });
                                    setActiveFileContent(data.tool_result.content);
                                }
                            }
                        }
                    } catch (e) { }
                }
            }
        } catch { } finally {
            setIsLoading(false);
            setCurrentPhase(null);
        }
    };

    return (
        <div className="flex flex-col h-screen bg-dark-950 text-white overflow-hidden">
            {/* Top Bar / Header */}
            <header className="flex items-center justify-between px-4 py-2 bg-dark-900 border-b border-white/5 z-20">
                <div className="flex items-center gap-4">
                    <div className="flex items-center gap-2">
                        <div className="w-2 h-2 rounded-full bg-violet-500 shadow-[0_0_8px_rgba(139,92,246,0.5)]" />
                        <span className="font-bold text-xs tracking-widest uppercase opacity-80">Luna IDE</span>
                    </div>
                    {projectRoot && (
                        <div className="flex items-center gap-2 px-3 py-1 bg-white/5 rounded-full text-[10px] text-white/40 border border-white/5">
                            <FolderTree size={10} />
                            <span className="truncate max-w-[200px]">{projectRoot}</span>
                        </div>
                    )}
                </div>

                <div className="flex items-center gap-3">
                    <button
                        onClick={() => setSidebarVisible(!sidebarVisible)}
                        className={`p-1.5 rounded transition-all ${sidebarVisible ? "text-violet-400 bg-violet-500/10" : "text-white/20 hover:text-white/40"}`}
                        title="Alternar Explorer"
                    >
                        <FolderTree size={16} />
                    </button>
                    <div className="h-4 w-px bg-white/10" />
                    <div className="flex items-center gap-1.5 text-white/30 text-xs text-right">
                        <span className="text-[10px] opacity-40 uppercase tracking-tighter">Membrana Sem√¢ntica</span>
                        <Brain size={12} className="text-violet-500" />
                        <span>{memoryCount}</span>
                    </div>
                </div>
            </header>

            {/* Main Content Area */}
            <div className="flex-1 flex overflow-hidden">
                {/* Sidebar: Sempre vis√≠vel */}
                {sidebarVisible && (
                    <aside className="w-64 bg-dark-900 border-r border-white/5 flex flex-col animate-in slide-in-from-left duration-300">
                        <div className="px-4 py-3 text-[10px] font-bold text-white/30 uppercase tracking-widest border-b border-white/5 flex items-center justify-between bg-dark-900">
                            <div className="flex gap-4">
                                {projectRoot && (
                                    <button
                                        onClick={() => setSidebarTab("files")}
                                        className={`hover:text-violet-300 transition-colors flex items-center gap-1.5 ${sidebarTab === "files" ? "text-violet-400" : ""}`}
                                    >
                                        <FolderTree size={12} /> Explorer
                                    </button>
                                )}
                                <button
                                    onClick={() => setSidebarTab("chats")}
                                    className={`hover:text-violet-300 transition-colors flex items-center gap-1.5 ${sidebarTab === "chats" ? "text-violet-400" : ""}`}
                                >
                                    <MessageSquare size={12} /> Chats
                                </button>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto bg-dark-900">
                            {sidebarTab === "files" && projectRoot ? (
                                <FileExplorer
                                    tree={fileTree}
                                    projectRoot={projectRoot}
                                    activeFile={activeFile}
                                    onFileClick={handleFileClick}
                                    onToggleFolder={handleToggleFolder}
                                />
                            ) : (
                                <ChatSidebar
                                    chats={chats}
                                    currentChatId={currentChatId}
                                    currentThreadId={currentThreadId}
                                    onLoadChat={handleLoadChat}
                                    onLoadThread={handleLoadThread}
                                    onNewChat={handleNewChat}
                                    onRefresh={loadChats}
                                />
                            )}
                        </div>
                    </aside>
                )}

                {/* Conte√∫do Principal baseado no Modo */}
                {appMode === 'writer' && (
                    <WriterView
                        onBack={() => setAppMode(null)}
                        onDocumentChange={setDocumentContext}
                        isLunaLoading={isLoading}
                        onQuickAction={(command) => {
                            // Simplesmente seta o input e dispara o envio
                            // Isso garante que reutilizamos toda a l√≥gica do sendMessage
                            if (isLoading) return;
                            setInput(command);
                            // Pequeno delay para permitir que o React atualize o input
                            setTimeout(() => {
                                const form = document.querySelector('form');
                                if (form) {
                                    form.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                                }
                            }, 50);
                        }}
                    />
                )}

                {appMode !== 'writer' && !projectRoot && (
                    <WelcomeView
                        onOpenProject={handleOpenProject}
                        onNewProject={handleNewProject}
                        onSelectMode={setAppMode}
                        selectedMode={appMode}
                    />
                )}

                {appMode === 'ide' && projectRoot && (
                    <>

                        {/* Editor Area */}
                        <CodeEditor
                            file={activeFile}
                            content={activeFileContent}
                            onChange={(value) => setActiveFileContent(value)}
                            onSave={handleSaveFile}
                            onClose={() => setActiveFile(null)}
                        />
                    </>
                )}

                {/* Chat / Timeline Area (Sempre vis√≠vel se quiser, ou colaps√°vel se preferir) */}
                <aside className={`${!projectRoot ? 'w-full max-w-2xl mx-auto' : 'w-[450px]'} flex flex-col bg-dark-900/50 backdrop-blur-xl border-l border-white/5 overflow-hidden transition-all duration-300`}>
                    <div className="px-4 py-3 text-[10px] font-bold text-white/30 uppercase tracking-widest border-b border-white/5 flex items-center justify-between bg-dark-900">
                        <span>{projectRoot ? "Timeline & Brain" : "Conversa Inicial"}</span>
                        <TerminalIcon size={10} />
                    </div>

                    <div className="flex-1 overflow-y-auto px-4 py-6 scrollbar-thin">
                        <div className="space-y-6">
                            {messages.map((msg, i) => (
                                <div key={i} className={`flex ${msg.role === "user" ? "justify-end" : "justify-start"}`}>
                                    <div className={`${msg.role === "user"
                                        ? "bg-violet-600/90 text-white rounded-2xl px-4 py-2.5 max-w-[90%] shadow-lg shadow-violet-900/20"
                                        : "w-full space-y-2"}`}>

                                        {msg.role === "user" ? (
                                            <div className="space-y-2">
                                                {msg.image && (
                                                    <div className="rounded-lg overflow-hidden border border-white/20 mb-2 max-w-sm">
                                                        <img src={`data:image/jpeg;base64,${msg.image}`} alt="Enviado pelo usu√°rio" className="w-full h-auto" />
                                                    </div>
                                                )}
                                                <div className="text-sm leading-relaxed">{msg.content}</div>
                                            </div>
                                        ) : (
                                            <div className="border-l-2 border-white/10 ml-1 pl-6 relative pb-2">
                                                <div className="absolute -left-[5px] top-2 w-2 h-2 rounded-full bg-violet-500/50" />
                                                {renderEvents(msg.events)}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ))}

                            {/* Streaming em andamento */}
                            {isLoading && (
                                <div className="flex justify-start w-full">
                                    <div className="w-full border-l-2 border-violet-500/30 ml-1 pl-6 relative animate-in fade-in duration-500">
                                        <div className="absolute -left-[5px] top-2 w-2 h-2 rounded-full bg-violet-400 animate-ping" />
                                        {renderEvents(streamingEvents)}

                                        {currentPhase && streamingEvents.length === 0 && (
                                            <div className="flex items-center gap-2 text-white/40 text-[10px] mt-2 uppercase tracking-widest font-bold">
                                                <Loader2 size={10} className="animate-spin text-violet-400" />
                                                <span>{currentPhase}</span>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            <div ref={messagesEndRef} />
                        </div>
                    </div>

                    {/* Input Area (dentro do painel de chat) */}
                    <footer className="p-4 bg-dark-900 border-t border-white/5 space-y-3">
                        {/* Context Badge para Writer Mode */}
                        {appMode === 'writer' && documentContext && (
                            <div className="flex items-center gap-2 context-badge-active">
                                <div className="flex items-center gap-2 px-3 py-1.5 bg-emerald-500/10 border border-emerald-500/20 rounded-lg">
                                    <FileText size={12} className="text-emerald-400" />
                                    <span className="text-[10px] text-emerald-300 font-medium">
                                        Contexto: <span className="text-white/60">{documentContext.sectionTitle}</span>
                                    </span>
                                    <span className="text-[9px] text-white/20">
                                        ({documentContext.content?.split(/\s+/).filter(Boolean).length || 0} palavras)
                                    </span>
                                    {documentContext.lockedSectionId && (
                                        <span className="text-[9px] text-amber-300 ml-2 px-1.5 py-0.5 bg-amber-500/10 border border-amber-500/20 rounded">
                                            Fixada
                                        </span>
                                    )}
                                </div>
                            </div>
                        )}

                        {imagePreview && (
                            <div className="relative inline-block animate-in fade-in zoom-in duration-300">
                                <img src={imagePreview} alt="Preview" className="w-20 h-20 object-cover rounded-xl border-2 border-violet-500/50 shadow-lg" />
                                <button
                                    onClick={() => { setImagePreview(null); setSelectedImage(null); }}
                                    className="absolute -top-2 -right-2 bg-red-500 rounded-full p-1 shadow-md hover:bg-red-600 transition-colors"
                                >
                                    <X size={12} />
                                </button>
                            </div>
                        )}
                        <div className="flex items-end gap-2 bg-white/5 border border-white/10 rounded-xl p-2 focus-within:border-violet-500/50 transition-colors">
                            <input
                                type="file"
                                ref={fileInputRef}
                                onChange={handleImageSelect}
                                accept="image/*"
                                className="hidden"
                            />
                            <button
                                onClick={() => fileInputRef.current?.click()}
                                className="p-2.5 text-white/30 hover:text-white/60 transition-colors flex-shrink-0"
                                title="Anexar Imagem"
                            >
                                <ImageIcon size={20} />
                            </button>
                            <textarea
                                ref={inputRef}
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                onPaste={handlePaste}
                                onKeyDown={(e) => {
                                    if (e.key === "Enter" && !e.shiftKey) {
                                        e.preventDefault();
                                        sendMessage();
                                    }
                                }}
                                placeholder="Pergunte ou pe√ßa uma altera√ß√£o..."
                                rows={1}
                                className="flex-1 bg-transparent px-2 py-2 text-white placeholder-white/20 outline-none text-sm resize-none max-h-40 overflow-y-auto"
                                style={{ minHeight: '40px' }}
                            />
                            <button
                                onClick={sendMessage}
                                disabled={(!input.trim() && !selectedImage) || isLoading}
                                className="p-2.5 bg-violet-600 hover:bg-violet-500 disabled:bg-white/5 disabled:text-white/10 rounded-lg transition-all flex-shrink-0"
                            >
                                <Send size={16} />
                            </button>
                        </div>
                    </footer>
                </aside>
            </div>
        </div>
    );
}

export default App;
